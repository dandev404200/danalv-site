# Development docker-compose - runs PostgreSQL and Miniflux only
# Run your backend separately with: uv run uvicorn app.main:app --reload --port 8000
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d
#
# Access:
#   - PostgreSQL: localhost:5432
#   - Miniflux UI: http://localhost:8080
#
# Backend .env file:
#   DATABASE_URL=postgresql://miniflux:miniflux@localhost:5432/miniflux
#   ENVIRONMENT=development

services:
  # PostgreSQL - exposed on localhost:5432 for local backend
  postgres:
    image: postgres:18-alpine
    container_name: daily-digest-postgres-dev
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=miniflux
      - POSTGRES_PASSWORD=miniflux
      - POSTGRES_DB=miniflux
    volumes:
      - miniflux-db-dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "miniflux", "-d", "miniflux"]
      interval: 10s
      start_period: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - daily-digest-dev

  # Miniflux - exposed on localhost:8080 for feed management
  miniflux:
    image: miniflux/miniflux:latest
    container_name: daily-digest-miniflux-dev
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgres://miniflux:miniflux@postgres/miniflux?sslmode=disable
      - RUN_MIGRATIONS=1
      - CREATE_ADMIN=1
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=dev123456
    restart: unless-stopped
    networks:
      - daily-digest-dev

networks:
  daily-digest-dev:
    driver: bridge

volumes:
  miniflux-db-dev:
